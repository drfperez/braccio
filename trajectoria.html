<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planificaci√≥ i Din√†mica de Traject√≤ria 2-DOF amb Tra√ßa de l‚ÄôEfector</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script>
    MathJax = {
      tex: { inlineMath: [['\\(', '\\)']], displayMath: [['$$', '$$']] }
    };
  </script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f4f9;
      color: #333;
      margin: 20px;
      line-height: 1.6;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }
    h1 {
      color: #4CAF50;
      text-align: center;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
    }
    h2 {
      color: #0056b3;
      margin-top: 25px;
      border-left: 5px solid #0056b3;
      padding-left: 10px;
    }
    label { display: inline-block; width: 110px; }
    input {
      margin: 5px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 90px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover { background: #45a049; }
    canvas { margin-top: 20px; }
    .math { text-align: center; font-size: 1.1em; }
  </style>
</head>
<body>

<div class="container">
  <h1>Planificaci√≥ i Din√†mica de Traject√≤ria 2-DOF amb Tra√ßa ü¶æ</h1>
  <p>Simulador interactiu que calcula les traject√≤ries c√∫biques, la din√†mica i mostra el moviment del bra√ß rob√≤tic amb el cam√≠ de l‚Äôefector final.</p>

  <h2>Entrada de Dades</h2>
  <div>
    <h3>Articulaci√≥ 1</h3>
    <label>q‚ÇÅ‚ÇÄ (¬∞):</label><input type="number" id="q10" value="10"><br>
    <label>q‚ÇÅf (¬∞):</label><input type="number" id="q1f" value="70"><br>

    <h3>Articulaci√≥ 2</h3>
    <label>q‚ÇÇ‚ÇÄ (¬∞):</label><input type="number" id="q20" value="30"><br>
    <label>q‚ÇÇf (¬∞):</label><input type="number" id="q2f" value="90"><br>

    <h3>Par√†metres comuns</h3>
    <label>t_f (s):</label><input type="number" id="tf" value="3" step="0.1"><br>
    <label>I (kg¬∑m¬≤):</label><input type="number" id="I" value="1" step="0.1"><br>
    <label>b (N¬∑m¬∑s/rad):</label><input type="number" id="b" value="0.1" step="0.01"><br>
    <label>g (N¬∑m):</label><input type="number" id="g" value="9.81" step="0.01"><br>
    <button onclick="calcular2DOF()">Calcula Traject√≤ries</button>
  </div>

  <h2>Resultats</h2>
  <p id="coef2"></p>

  <div class="math">
    $$ q_i(t) = a_{i0} + a_{i1} t + a_{i2} t^2 + a_{i3} t^3 $$
    $$ \dot{q}_i(t) = a_{i1} + 2a_{i2} t + 3a_{i3} t^2 $$
    $$ \ddot{q}_i(t) = 2a_{i2} + 6a_{i3} t $$
    $$ \tau_i(t) = I \ddot{q}_i + b \dot{q}_i + g \sin(q_i) $$
  </div>

  <canvas id="chart_q1"></canvas>
  <canvas id="chart_q2"></canvas>
  <canvas id="chart_tau1"></canvas>
  <canvas id="chart_tau2"></canvas>

  <h2>Animaci√≥ del Bra√ß 2-DOF i Tra√ßa üß≠</h2>
  <canvas id="animacio" width="500" height="400" style="background:#eef; border-radius:10px;"></canvas>
  <button onclick="iniciarAnimacio2DOF()">‚ñ∂Ô∏è Reproduir Animaci√≥</button>
</div>

<script>
let trajectoria2 = {t:[], q1:[], q2:[], tau1:[], tau2:[], tf:0};
let coef2 = {};
let tra√ßaEfector = [];
let anim2id;


function calcular2DOF() {
  const q10 = parseFloat(document.getElementById("q10").value);
  const q1f = parseFloat(document.getElementById("q1f").value);
  const q20 = parseFloat(document.getElementById("q20").value);
  const q2f = parseFloat(document.getElementById("q2f").value);
  const tf = parseFloat(document.getElementById("tf").value);
  const I = parseFloat(document.getElementById("I").value);
  const b = parseFloat(document.getElementById("b").value);
  const g = parseFloat(document.getElementById("g").value);

  // --- C√†lcul pas a pas Articulaci√≥ 1 ---
  const a10 = q10;
  const a11 = 0;
  const a13 = (2 * (q10 - q1f)) / Math.pow(tf,3);
  const a12 = (3 * (q1f - q10)) / Math.pow(tf,2);

  // --- C√†lcul pas a pas Articulaci√≥ 2 ---
  const a20 = q20;
  const a21 = 0;
  const a23 = (2 * (q20 - q2f)) / Math.pow(tf,3);
  const a22 = (3 * (q2f - q20)) / Math.pow(tf,2);

  // Variables de coeficients articulaci√≥ per a la resta del codi
  const c1 = { a0: a10, a1: a11, a2: a12, a3: a13 };
  const c2 = { a0: a20, a1: a21, a2: a22, a3: a23 };
  coef2 = { c1, c2, I, b, g, tf };

  // Explicaci√≥ detallada pas a pas amb MathJax
  document.getElementById("coef2").innerHTML = `
    <div>
    $$
      \\textbf{Articulaci√≥ 1:}
    $$
    $$
      a_{10} = q_{10} = ${a10}
    $$
    $$
      a_{11} = 0
    $$
    $$
      a_{13} = \\frac{2(q_{10} - q_{1f})}{t_f^3} = \\frac{2(${q10} - ${q1f})}{${tf}^3} = ${a13.toFixed(4)}
    $$
    $$
      a_{12} = \\frac{3(q_{1f} - q_{10})}{t_f^2} = \\frac{3(${q1f} - ${q10})}{${tf}^2} = ${a12.toFixed(4)}
    $$
    $$
      \\textbf{Coeficients finals:}
    $$
    $$
      a_{10} = ${a10.toFixed(2)},\\quad a_{11} = 0,\\quad a_{12} = ${a12.toFixed(2)},\\quad a_{13} = ${a13.toFixed(2)}
    $$
    $$
      \\textbf{Articulaci√≥ 2:}
    $$
    $$
      a_{20} = q_{20} = ${a20}
    $$
    $$
      a_{21} = 0
    $$
    $$
      a_{23} = \\frac{2(q_{20} - q_{2f})}{t_f^3} = \\frac{2(${q20} - ${q2f})}{${tf}^3} = ${a23.toFixed(4)}
    $$
    $$
      a_{22} = \\frac{3(q_{2f} - q_{20})}{t_f^2} = \\frac{3(${q2f} - ${q20})}{${tf}^2} = ${a22.toFixed(4)}
    $$
    $$
      \\textbf{Coeficients finals:}
    $$
    $$
      a_{20} = ${a20.toFixed(2)},\\quad a_{21} = 0,\\quad a_{22} = ${a22.toFixed(2)},\\quad a_{23} = ${a23.toFixed(2)}
    $$
    </div>
  `;
  // Re-renderitza MathJax despr√©s d'actualitzar el contingut
  if (window.MathJax) window.MathJax.typeset();

  // ---- GENERACI√ì DE LA TRAJECT√íRIA NUM√àRICA I DIN√ÄMICA ----
  const t = [], q1 = [], q2 = [], tau1 = [], tau2 = [];
  const n = 200;
  for (let i=0; i<=n; i++) {
    const time = tf * i / n;
    // C√†lcul posici√≥, velocitat i acceleraci√≥
    const q1t = c1.a0 + c1.a1*time + c1.a2*Math.pow(time,2) + c1.a3*Math.pow(time,3);
    const dq1 = c1.a1 + 2*c1.a2*time + 3*c1.a3*Math.pow(time,2);
    const ddq1 = 2*c1.a2 + 6*c1.a3*time;

    const q2t = c2.a0 + c2.a1*time + c2.a2*Math.pow(time,2) + c2.a3*Math.pow(time,3);
    const dq2 = c2.a1 + 2*c2.a2*time + 3*c2.a3*Math.pow(time,2);
    const ddq2 = 2*c2.a2 + 6*c2.a3*time;

    // Torque per cada articulaci√≥
    const tau1_t = I*ddq1 + b*dq1 + g*Math.sin(q1t*Math.PI/180);
    const tau2_t = I*ddq2 + b*dq2 + g*Math.sin(q2t*Math.PI/180);

    t.push(time);
    q1.push(q1t);
    q2.push(q2t);
    tau1.push(tau1_t);
    tau2.push(tau2_t);
  }

  trajectoria2 = {t, q1, q2, tau1, tau2, tf};

  // --- CREACI√ì DE GR√ÄFIQUES ---
  crearGraf("chart_q1", "q‚ÇÅ(t) [¬∞]", t, q1);
  crearGraf("chart_q2", "q‚ÇÇ(t) [¬∞]", t, q2);
  crearGraf("chart_tau1", "œÑ‚ÇÅ(t) [N¬∑m]", t, tau1);
  crearGraf("chart_tau2", "œÑ‚ÇÇ(t) [N¬∑m]", t, tau2);
}



function crearGraf(id, label, t, data) {
  const ctx = document.getElementById(id);
  new Chart(ctx, {
    type: 'line',
    data: { labels: t, datasets: [{ label: label, data: data, borderWidth: 2, tension: 0.3 }] },
    options: { responsive: true, scales: { x: { title: { display: true, text: "Temps [s]" } } } }
  });
}

// === ANIMACI√ì 2-DOF amb tra√ßa corregida ===
function iniciarAnimacio2DOF() {
  if (!trajectoria2.t.length) { alert("Primer calcula les traject√≤ries!"); return; }

  cancelAnimationFrame(anim2id);
  const canvas = document.getElementById("animacio");
  const ctx = canvas.getContext("2d");
  const L1 = 100, L2 = 80;
  const {c1, c2, tf} = coef2;
  tra√ßaEfector = [];
  let start = null;

  function q_i(c, t) {
    return c.a0 + c.a1*t + c.a2*t**2 + c.a3*t**3;
  }

  function dibuixarBra√ß(q1deg, q2deg) {
    const x0 = canvas.width/2, y0 = canvas.height - 60;
    const rad1 = q1deg * Math.PI / 180 - Math.PI/2;
    const rad2 = q2deg * Math.PI / 180;
    const x1 = x0 + L1 * Math.cos(rad1);
    const y1 = y0 + L1 * Math.sin(rad1);
    const x2 = x1 + L2 * Math.cos(rad1 + rad2);
    const y2 = y1 + L2 * Math.sin(rad1 + rad2);

    tra√ßaEfector.push({x: x2, y: y2});

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Tra√ßa del punt final
    ctx.strokeStyle = "rgba(0,0,255,0.6)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    for (let i=0; i<tra√ßaEfector.length; i++) {
      const p = tra√ßaEfector[i];
      if (i===0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y);
    }
    ctx.stroke();

    // Bra√ß
    ctx.lineWidth = 8;
    ctx.strokeStyle = "#4CAF50";
    ctx.beginPath();
    ctx.moveTo(x0, y0);
    ctx.lineTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();

    // Articulacions
    ctx.fillStyle = "#333";
    ctx.beginPath();
    ctx.arc(x0, y0, 10, 0, 2*Math.PI);
    ctx.fill();

    ctx.fillStyle = "#f90";
    ctx.beginPath();
    ctx.arc(x1, y1, 8, 0, 2*Math.PI);
    ctx.fill();

    ctx.fillStyle = "#e33";
    ctx.beginPath();
    ctx.arc(x2, y2, 6, 0, 2*Math.PI);
    ctx.fill();
  }

  function animar(timestamp) {
    if (!start) start = timestamp;
    const elapsed = (timestamp - start) / 1000;
    const t = Math.min(elapsed, tf);

    const q1_t = q_i(c1, t);
    const q2_t = q_i(c2, t);
    dibuixarBra√ß(q1_t, q2_t);

    if (elapsed < tf) anim2id = requestAnimationFrame(animar);
  }

  requestAnimationFrame(animar);
}
</script>

<!-- BOT√ì PER OBRIR EL MODAL -->
<button id="btnExempleModal" style="margin:20px 0;">üõë Exemple pas a pas Cubic PTP</button>

<!-- MODAL PERSONALITZAT -->
<div id="modalExample" style="display:none;position:fixed;z-index:10000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;">
  <div id="modalExampleContent" style="max-width:900px;background:#fff;padding:2em;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.18);overflow-y:auto;max-height:85vh;position:relative;">
    <span id="closeModalExample" style="position:absolute;top:.5em;right:.8em;font-size:2em;cursor:pointer;">&times;</span>
  

    <!-- INICI CONTINGUT EXEMPLE -->

<div class="container">
    <h1>Planificaci√≥ de Traject√≤ria: Polinomi C√∫bic (PTP) üõ£Ô∏è</h1>
    <p>Aquest m√®tode (Polinomi de 3r grau) genera una traject√≤ria suau entre un punt inicial (\(q_0\)) i un punt final (\(q_f\)), garantint sempre que la <b>velocitat inicial i final siguin zero</b> per evitar moviments bruscos.</p>
    
    <hr>

    <div class="data-input">
        <h2>Entrada de Dades de l'Usuari üïπÔ∏è</h2>
        <p>Suposem que volem moure la nostra articulaci√≥ (per exemple, l'angle d'un motor) segons aquests par√†metres:</p>
        
        <div class="math">
            \( q(t_0) = \boldsymbol{q_0} = \mathbf{10^\circ} \) (Posici√≥ Inicial)
        </div>
        <div class="math">
            \( q(t_f) = \boldsymbol{q_f} = \mathbf{70^\circ} \) (Posici√≥ Final)
        </div>
        <div class="math">
            \( t_f = \mathbf{3 \text{ segons}} \) (Temps de Transici√≥)
        </div>
        
        <p class="note">Nota: Per simplificar, assumim temps inicial \( t_0 = 0 \text{ s} \), velocitat inicial \( \dot{q}_0 = 0 \) i velocitat final \( \dot{q}_f = 0 \).</p>
    </div>

    <div class="solution-steps">
        <h2>F√≥rmula i Soluci√≥ Pas a Pas üìê</h2>

        <h3>1. La Traject√≤ria i les seves Derivades</h3>
        <p>El polinomi de tercer grau t√© quatre coeficients (\(a_0, a_1, a_2, a_3\)) que hem de trobar:</p>
        <div class="math">
            $$
            q(t) = a_0 + a_1 t + a_2 t^2 + a_3 t^3 
            $$
        </div>
        <p>Les seves derivades (Velocitat i Acceleraci√≥) s√≥n:</p>
        <div class="math">
            $$
            \dot{q}(t) = a_1 + 2 a_2 t + 3 a_3 t^2 \quad \text{(Velocitat)} 
            $$
            $$
            \ddot{q}(t) = 2 a_2 + 6 a_3 t \quad \text{(Acceleraci√≥)} 
            $$
        </div>

        <h3>2. Aplicaci√≥ de les Condicions de Contorn</h3>
        <p>Apliquem les quatre condicions (posici√≥ i velocitat a \(t=0\) i \(t=t_f\)) per crear un sistema de 4 equacions:</p>
        
        <div class="step">
            <h4>Condici√≥ 1: Posici√≥ Inicial (\(t=0\))</h4>
            <div class="math">
                \( q(0) = q_0 = a_0 + a_1(0) + a_2(0) + a_3(0) \quad \Rightarrow \quad \mathbf{a_0 = q_0} \)
                <br>
                Substituint dades: \( \mathbf{a_0 = 10} \)
            </div>
        </div>
        
        <div class="step">
            <h4>Condici√≥ 2: Velocitat Inicial (\(t=0\))</h4>
            <div class="math">
                \( \dot{q}(0) = \dot{q}_0 = a_1 + 2 a_2(0) + 3 a_3(0) \quad \Rightarrow \quad \mathbf{a_1 = \dot{q}_0} \)
                <br>
                Com que \(\dot{q}_0 = 0\): \( \mathbf{a_1 = 0} \)
            </div>
        </div>
        
        <div class="step">
            <h4>Condici√≥ 3: Posici√≥ Final (\(t=t_f\))</h4>
            <div class="math">
                \( q(t_f) = q_f = a_0 + a_1 t_f + a_2 t_f^2 + a_3 t_f^3 \)
            </div>
        </div>
        
        <div class="step">
            <h4>Condici√≥ 4: Velocitat Final (\(t=t_f\))</h4>
            <div class="math">
                \( \dot{q}(t_f) = \dot{q}_f = a_1 + 2 a_2 t_f + 3 a_3 t_f^2 \)
            </div>
        </div>

        <h3>3. Resoluci√≥ del Sistema (Substituci√≥ de Valors)</h3>
        <p>Amb \(a_0=10\), \(a_1=0\), \(q_f=70\) i \(t_f=3\), simplifiquem i resolem per \(a_2\) i \(a_3\):</p>

        <div class="step">
            <h4>De la Condici√≥ 4 (Velocitat Final):</h4>
            <div class="math">
                \( 0 = 0 + 2 a_2 (3) + 3 a_3 (3)^2 \quad \Rightarrow \quad 0 = 6 a_2 + 27 a_3 \)
                <br>
                A√Øllem \(a_2\): \( a_2 = - \frac{27}{6} a_3 = \mathbf{-4.5 a_3} \)
            </div>
        </div>
        
        <div class="step">
            <h4>De la Condici√≥ 3 (Posici√≥ Final):</h4>
            <div class="math">
                \( 70 = 10 + 0(3) + a_2 (3)^2 + a_3 (3)^3 \)
                <br>
                \( 60 = 9 a_2 + 27 a_3 \)
                <br>
                Substitu√Øm \(a_2 = -4.5 a_3\) a l'equaci√≥:
                <br>
                \( 60 = 9 (-4.5 a_3) + 27 a_3 \)
                <br>
                \( 60 = -40.5 a_3 + 27 a_3 \)
                <br>
                \( 60 = -13.5 a_3 \quad \Rightarrow \quad \mathbf{a_3 \approx -4.444} \)
            </div>
        </div>

        <div class="step">
            <h4>C√†lcul Final de \(a_2\):</h4>
            <div class="math">
                \( a_2 = -4.5 a_3 = -4.5 (-4.444) \quad \Rightarrow \quad \mathbf{a_2 = 20} \)
            </div>
        </div>

        <h3>4. Soluci√≥ Final de la Traject√≤ria üöÄ</h3>
        <p>Substituint tots els coeficients trobats:</p>
        <div class="math">
            $$
            \mathbf{a_0 = 10} \quad \mathbf{a_1 = 0} \quad \mathbf{a_2 = 20} \quad \mathbf{a_3 = -4.444}
            $$
        </div>
        <p>L'equaci√≥ de la traject√≤ria de l'articulaci√≥ √©s:</p>
        <div class="math">
            $$
            \mathbf{q(t) = 10 + 20 t^2 - 4.444 t^3}
            $$
        </div>
        <p class="note">Aquesta funci√≥ d√≥na la posici√≥ de l'articulaci√≥ (en graus) per a qualsevol instant \(t\) entre 0 i 3 segons. El controlador utilitzar√† aquesta funci√≥ per calcular el moment \(\boldsymbol{\tau}\) necessari a cada pas de temps (utilitzant la din√†mica).</p>

  
    <!-- FI CONTINGUT EXEMPLE -->

  </div>
</div>
<script>
  document.getElementById('btnExempleModal').onclick = function() {
    var modal = document.getElementById('modalExample');
    modal.style.display = 'flex'; // Canvia a flex per mostrar el modal!
    if (window.MathJax) window.MathJax.typesetPromise();
  };
  document.getElementById('closeModalExample').onclick = function() {
    document.getElementById('modalExample').style.display = 'none';
  };
  document.getElementById('modalExample').onclick = function(e) {
    if (e.target === this) this.style.display = 'none';
  };
</script>

</body>
</html>
